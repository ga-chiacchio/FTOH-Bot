var Circuit1 = `{"name":"Rally test 3 By Nanoseb","width":2300,"height":2100,"spawnDistance":700,"bg":{"type":"hockey","height":0,"width":0,"cornerRadius":0,"kickOffRadius":0},"vertexes":[{"x":-500,"y":-21,"bCoef":0.2,"cMask":["red","blue"],"color":"524645","curve":0,"speed":[0,0]},{"x":-500,"y":-183,"bCoef":0.2,"cMask":["red","blue"],"curve":0,"speed":[0,0],"color":"524645"},{"x":140,"y":-183,"bCoef":0.2,"cMask":["red","blue"],"curve":0,"speed":[0,0],"color":"524645"},{"x":0,"y":-183,"bCoef":0.2,"cMask":["all"],"cGroup":["redKO","blueKO"],"color":"ffffff","speed":[0,0]},{"x":0,"y":-21,"bCoef":0.2,"cMask":["all"],"cGroup":["redKO","blueKO"],"color":"ffffff","speed":[0,0]},{"x":100,"y":-84,"bCoef":0.2,"cMask":["all"],"cGroup":["redKO","blueKO"],"curve":-180,"color":"ffffff","speed":[0,0]},{"x":100,"y":-54,"bCoef":0.2,"cMask":["all"],"cGroup":["redKO","blueKO"],"curve":-180,"color":"ffffff","speed":[0,0]},{"x":2842.444751918742,"y":-1229.2892578038552},{"x":140,"y":-21,"bCoef":0.2,"cMask":["red","blue"],"color":"524645"},{"x":-668,"y":325,"bCoef":0.2,"cMask":["red","blue"]},{"x":-580,"y":227,"bCoef":0.2,"cMask":["red","blue"]},{"x":-766,"y":617,"bCoef":0.2,"cMask":["red","blue"]},{"x":-756,"y":719,"bCoef":0.2,"cMask":["red","blue"]},{"x":-858,"y":615,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1330,"y":649,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1756,"y":643,"bCoef":0.2,"cMask":["red","blue"]},{"x":-866,"y":715,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1314,"y":755,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1714,"y":745,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1720,"y":913,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1770,"y":1039,"bCoef":0.2,"cMask":["red","blue"]},{"x":-624,"y":1105,"bCoef":0.2,"cMask":["red","blue"]},{"x":-628,"y":961,"bCoef":0.2,"cMask":["red","blue"]},{"x":-312,"y":941,"bCoef":0.2,"cMask":["red","blue"]},{"x":106,"y":979,"bCoef":0.2,"cMask":["red","blue"]},{"x":234,"y":837,"bCoef":0.2,"cMask":["red","blue"]},{"x":188,"y":567,"bCoef":0.2,"cMask":["red","blue"]},{"x":222,"y":413,"bCoef":0.2,"cMask":["red","blue"]},{"x":432,"y":317,"bCoef":0.2,"cMask":["red","blue"]},{"x":789.0143999999999,"y":409.88345599999997,"bCoef":0.2,"cMask":["red","blue"]},{"x":1071.0144,"y":675.883456,"bCoef":0.2,"cMask":["red","blue"]},{"x":1128.130944,"y":1011.59712,"bCoef":0.2,"cMask":["red","blue"]},{"x":-324,"y":1081,"bCoef":0.2,"cMask":["red","blue"]},{"x":70,"y":1123,"bCoef":0.2,"cMask":["red","blue"]},{"x":394,"y":813,"bCoef":0.2,"cMask":["red","blue"]},{"x":358,"y":551,"bCoef":0.2,"cMask":["red","blue"]},{"x":370,"y":481,"bCoef":0.2,"cMask":["red","blue"]},{"x":428,"y":455,"bCoef":0.2,"cMask":["red","blue"]},{"x":736,"y":537,"bCoef":0.2,"cMask":["red","blue"]},{"x":942,"y":723,"bCoef":0.2,"cMask":["red","blue"]},{"x":990,"y":1005,"bCoef":0.2,"cMask":["red","blue"]},{"x":922.3200000000002,"y":1014.1200000000002,"bCoef":0.2,"cMask":["red","blue"]},{"x":887.7600000000002,"y":772.2000000000002,"bCoef":0.2,"cMask":["red","blue"]},{"x":666.8676644820405,"y":802.4949672306053,"bCoef":0.2,"cMask":["red","blue"]},{"x":714.9600000000002,"y":1312.2000000000003,"bCoef":0.2,"cMask":["red","blue"]},{"x":822.9600000000002,"y":1053.0000000000002,"bCoef":0.2,"cMask":["red","blue"]},{"x":799.2000000000002,"y":806.7600000000002,"bCoef":0.2,"cMask":["red","blue"]},{"x":760.3200000000002,"y":811.0800000000002,"bCoef":0.2,"cMask":["red","blue"]},{"x":799.2000000000002,"y":1292.7600000000002,"bCoef":0.2,"cMask":["red","blue"]},{"x":1248.0480000000005,"y":1221.2208000000003,"bCoef":0.2,"cMask":["red","blue"]},{"x":1348.3584000000005,"y":1200.2256000000004,"bCoef":0.2,"cMask":["red","blue"]},{"x":1175.7312000000004,"y":936.6192000000003,"bCoef":0.2,"cMask":["red","blue"]},{"x":1280.7072000000005,"y":670.6800000000002,"bCoef":0.2,"cMask":["red","blue"]},{"x":1206.0576000000003,"y":505.05120000000016,"bCoef":0.2,"cMask":["red","blue"]},{"x":1236.3840000000005,"y":353.4192000000001,"bCoef":0.2,"cMask":["red","blue"]},{"x":1220.0544000000004,"y":227.44800000000006,"bCoef":0.2,"cMask":["red","blue"]},{"x":1273.7088,"y":113.14080000000004,"bCoef":0.2,"cMask":["red","blue"]},{"x":1511.6544000000004,"y":131.80320000000006,"bCoef":0.2,"cMask":["red","blue"]},{"x":1581.6384000000005,"y":204.12000000000006,"bCoef":0.2,"cMask":["red","blue"]},{"x":1793.9232000000006,"y":334.7568000000001,"bCoef":0.2,"cMask":["red","blue"]},{"x":1898.8992000000005,"y":446.7312000000002,"bCoef":0.2,"cMask":["red","blue"]},{"x":2043.5328000000006,"y":362.7504000000001,"bCoef":0.2,"cMask":["red","blue"]},{"x":1283.0400000000004,"y":938.9520000000003,"bCoef":0.2,"cMask":["red","blue"]},{"x":1397.3472000000004,"y":668.3472000000003,"bCoef":0.2,"cMask":["red","blue"]},{"x":1308.7008000000005,"y":486.3888000000002,"bCoef":0.2,"cMask":["red","blue"]},{"x":1336.6944000000005,"y":344.08800000000014,"bCoef":0.2,"cMask":["red","blue"]},{"x":1325.0304000000003,"y":264.7728000000001,"bCoef":0.2,"cMask":["red","blue"]},{"x":1432.3392000000006,"y":208.78560000000004,"bCoef":0.2,"cMask":["red","blue"]},{"x":1518.6528000000005,"y":297.4320000000001,"bCoef":0.2,"cMask":["red","blue"]},{"x":1723.9392000000005,"y":414.0720000000001,"bCoef":0.2,"cMask":["red","blue"]},{"x":1826.5824000000007,"y":530.7120000000001,"bCoef":0.2,"cMask":["red","blue"]},{"x":2138.7931545600004,"y":353.0347545600001,"bCoef":0.2,"cMask":["red","blue"]},{"x":1601.2955059200008,"y":-567.3238963200002,"bCoef":0.2,"cMask":["red","blue"]},{"x":1342.8026035200007,"y":-744.1874611200004,"bCoef":0.2,"cMask":["red","blue"]},{"x":662.5581235200003,"y":-850.3056000000004,"bCoef":0.2,"cMask":["red","blue"]},{"x":20.40733440000001,"y":-785.0021299200004,"bCoef":0.2,"cMask":["red","blue"]},{"x":1712.8556006400008,"y":-586.3707417600003,"bCoef":0.2,"cMask":["red","blue"]},{"x":1372.7333606400007,"y":-836.7007104000004,"bCoef":0.2,"cMask":["red","blue"]},{"x":684.3259468800003,"y":-950.9817830400004,"bCoef":0.2,"cMask":["red","blue"]},{"x":-17.686356480000008,"y":-877.5153792000004,"bCoef":0.2,"cMask":["red","blue"]},{"x":20.40733440000001,"y":-738.7455052800003,"bCoef":0.2,"cMask":["red","blue"]},{"x":-14.965378560000007,"y":-651.6742118400003,"bCoef":0.2,"cMask":["red","blue"]},{"x":-77.2837072592593,"y":-528.6038091851854,"bCoef":0.2,"cMask":["red","blue"]},{"x":-27.713664000000012,"y":-602.1423360000002,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1275.5991823170375,"y":-1793,"bCoef":0.2,"cMask":["red","blue"],"curve":0,"speed":[0,0],"color":"524645"},{"x":-1415.5991823170375,"y":-1793,"bCoef":0.2,"cMask":["all"],"cGroup":["redKO","blueKO"],"color":"ffffff","speed":[0,0]},{"x":-1415.5991823170375,"y":-1631,"bCoef":0.2,"cMask":["all"],"cGroup":["redKO","blueKO"],"color":"ffffff","speed":[0,0]},{"x":-1275.5991823170375,"y":-1631,"bCoef":0.2,"cMask":["red","blue"],"color":"524645"},{"x":-1574,"y":-1793,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1574.6400000000006,"y":-1631,"bCoef":0.2,"cMask":["red","blue"]},{"x":-583.2000000000002,"y":-857.3040000000003,"bCoef":0.2,"cMask":["red","blue"]},{"x":-522.5472000000002,"y":-726.6672000000002,"bCoef":0.2,"cMask":["red","blue"]},{"x":-748.8288000000002,"y":-323.0928000000001,"bCoef":0.2,"cMask":["red","blue"]},{"x":-916.7904000000003,"y":-292.7664000000001,"bCoef":0.2,"cMask":["red","blue"]},{"x":-779.1552000000003,"y":-218.11680000000007,"bCoef":0.2,"cMask":["red","blue"]},{"x":-618.1920000000002,"y":-253.1088000000001,"bCoef":0.2,"cMask":["red","blue"]},{"x":-879.4656000000003,"y":110.80800000000004,"bCoef":0.2,"cMask":["red","blue"]},{"x":-944.7840000000003,"y":12.830400000000004,"bCoef":0.2,"cMask":["red","blue"]},{"x":-998.4384000000003,"y":-1083.5856000000003,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1080.0864000000004,"y":124.80480000000004,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1136.0736000000004,"y":-1090.5840000000003,"bCoef":0.2,"cMask":["red","blue"]},{"x":-821.1456000000003,"y":-1239.8832000000004,"bCoef":0.2,"cMask":["red","blue"]},{"x":-891.1296000000003,"y":-1309.8672000000004,"bCoef":0.2,"cMask":["red","blue"]},{"x":-996.1056000000003,"y":-1433.5056000000006,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1469.6640000000004,"y":-1174.5648000000003,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1045.0944000000004,"y":-1533.8160000000005,"bCoef":0.2,"cMask":["red","blue"]},{"x":-1511.6544000000006,"y":-1274.8752000000004,"bCoef":0.2,"cMask":["red","blue"]}],"segments":[{"v0":3,"v1":4,"color":"ffffff","bCoef":0.2,"cMask":["all"],"cGroup":["redKO","blueKO"],"x":0,"speed":[0,0]},{"v0":5,"v1":6,"curve":-180,"color":"ffffff","bCoef":0.2,"cMask":["all"],"cGroup":["redKO","blueKO"],"x":100,"speed":[0,0]},{"v0":2,"v1":8,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":2,"v1":1,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":8,"v1":0,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":1,"v1":9,"curve":-147.75236525967878,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":0,"v1":10,"curve":-150.8515676039225,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":9,"v1":11,"curve":146.75905072291027,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":10,"v1":12,"curve":146.75905072291027,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":11,"v1":13,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":13,"v1":14,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":14,"v1":15,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":12,"v1":16,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":16,"v1":17,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":17,"v1":18,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":18,"v1":19,"curve":-184.46561323540308,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":15,"v1":20,"curve":-173.93632243377215,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":20,"v1":21,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":19,"v1":22,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":22,"v1":23,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":23,"v1":24,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":24,"v1":25,"curve":-106.61422890123798,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":25,"v1":26,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":26,"v1":27,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":27,"v1":28,"curve":87.11521060501626,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":28,"v1":29,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":29,"v1":30,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":30,"v1":31,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":21,"v1":32,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":32,"v1":33,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":33,"v1":34,"curve":-102.22432207136191,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":34,"v1":35,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":35,"v1":36,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":36,"v1":37,"curve":102.91110443983331,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":37,"v1":38,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":38,"v1":39,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":39,"v1":40,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":40,"v1":41,"curve":180.96293161168182,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":41,"v1":42,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":42,"v1":43,"curve":-173.13583266016929,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":43,"v1":44,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":31,"v1":45,"curve":183.96441572998725,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":45,"v1":46,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":46,"v1":47,"curve":-190.6432460698357,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":47,"v1":48,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":48,"v1":49,"curve":-190.6432460698357,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":44,"v1":50,"curve":-190.6432460698357,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":49,"v1":51,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":51,"v1":52,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":52,"v1":53,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":53,"v1":54,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":54,"v1":55,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":55,"v1":56,"curve":62.472858424857414,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":56,"v1":57,"curve":70.71863346780188,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":57,"v1":58,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":58,"v1":59,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":59,"v1":60,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":60,"v1":61,"curve":-167.9020129003355,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":50,"v1":62,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":62,"v1":63,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":63,"v1":64,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":64,"v1":65,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":65,"v1":66,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":66,"v1":67,"curve":162.14627355508048,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":67,"v1":68,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":68,"v1":69,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":69,"v1":70,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":70,"v1":71,"curve":-157.00266093374898,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":61,"v1":72,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":72,"v1":73,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":73,"v1":74,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":74,"v1":75,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":71,"v1":76,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":76,"v1":77,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":77,"v1":78,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":78,"v1":79,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":75,"v1":80,"curve":-165.96783729588307,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":79,"v1":81,"curve":-160.35744682424018,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":80,"v1":82,"curve":189.04126452655905,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":83,"v1":81,"curve":-210.52547181864597,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":85,"v1":86,"color":"ffffff","bCoef":0.2,"cMask":["all"],"cGroup":["redKO","blueKO"],"x":0,"speed":[0,0]},{"v0":84,"v1":87,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":84,"v1":88,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":87,"v1":89,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"],"y":-1631},{"v0":83,"v1":90,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":82,"v1":91,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":91,"v1":92,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":90,"v1":93,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":93,"v1":94,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":92,"v1":95,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":95,"v1":96,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":94,"v1":97,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":97,"v1":98,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":96,"v1":99,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":99,"v1":100,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":98,"v1":101,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":100,"v1":102,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":102,"v1":103,"curve":-160.21759198638256,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":103,"v1":104,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":101,"v1":105,"curve":-157.3953753177324,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":105,"v1":106,"curve":0,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":89,"v1":106,"curve":-207.53109400211275,"color":"524645","bCoef":0.2,"cMask":["red","blue"]},{"v0":104,"v1":88,"curve":201.37780583144178,"color":"524645","bCoef":0.2,"cMask":["red","blue"]}],"goals":[],"discs":[{"radius":20,"pos":[1188.5616000000007,10.497600000000004],"bCoef":0.2,"cMask":["ball"],"cGroup":["ball"],"damping":1,"speed":[-2,0]}],"planes":[{"normal":[0,1],"dist":-184,"bCoef":0.25,"cMask":["red","blue"],"cGroup":["redKO","blueKO"],"_data":{"extremes":{"normal":[0,1],"dist":-184,"canvas_rect":[-2300,-2100,2842,2100],"a":[-2300,-184],"b":[2842,-184]}}},{"normal":[0,-1],"dist":20,"bCoef":0.25,"cMask":["red","blue"],"cGroup":["redKO","blueKO"],"_data":{"extremes":{"normal":[0,-1],"dist":20,"canvas_rect":[-2300,-2100,2842,2100],"a":[-2300,-20],"b":[2842,-20]}}},{"normal":[-1,0],"dist":-772.9293386974316,"bCoef":0.25,"cMask":["red","blue"],"cGroup":["redKO","blueKO"],"_data":{"extremes":{"normal":[-1,0],"dist":-772.9293386974316,"canvas_rect":[-2300,-2100,2842,2100],"a":[772.9293386974316,-2100],"b":[772.9293386974316,2100]}}},{"normal":[1,0],"dist":0,"bCoef":0.25,"cMask":["red","blue"],"cGroup":["redKO","blueKO"],"_data":{"extremes":{"normal":[1,0],"dist":0,"canvas_rect":[-2300,-2100,2842,2100],"a":[0,-2100],"b":[0,2100]}}}],"traits":{"ballArea":{"vis":false,"bCoef":1,"cMask":["ball"]},"goalPost":{"radius":8,"invMass":0,"bCoef":0.5},"goalNet":{"vis":true,"bCoef":0.1,"cMask":["ball"]},"kickOffBarrier":{"vis":false,"bCoef":0.1,"cGroup":["redKO","blueKO"],"cMask":["red","blue"]}},"playerPhysics":{"bCoef":0.5,"invMass":0.5,"damping":0.995,"acceleration":0.06,"kickingAcceleration":0,"kickingDamping":0.985,"kickStrength":0,"radius":15,"cGroup":["red","blue"],"gravity":[0,0],"kickback":0},"ballPhysics":{"radius":10,"bCoef":1e-20,"invMass":1e-20,"damping":1.0005,"cMask":["wall","ball"],"color":"66ff00","gravity":[0,0],"cGroup":["ball"]},"joints":[],"redSpawnPoints":[],"blueSpawnPoints":[[122,-71]],"cameraFollow":"player","canBeStored":false,"cameraWidth":0,"cameraHeight":0,"maxViewWidth":0,"kickOffReset":"partial"}`;

var _Circuit1 = {
  MinX: -5,
  MaxX: 5,
  MinY: -183,
  MaxY: -21, // ZONA DE INICIO
  DriveDirection: -1,
  StartDirection: "X",
  endMinX: -1410,
  endMaxX: -1380,
  endMinY: -1793,
  endMaxY: -1631, // ZONA DE META
  endDriveDirection: 1,
  endStartDirection: "X",
  Name: JSON.parse(Circuit1).name,
  BestTime: [999.99, undefined],
  MainColor: [0x000000, 0x000000, 0x000000],
  AvatarColor: 0x000000,
  Angle: 90,
  Team: 2,
  ID: 1,
};

//Same structure goes...

var limit = 3;
var lapChangeAnnouncementTimeout = 1;
var gameEndTimeout = 2000;

var Circuits = [Circuit1]; //...

var _Circuits = [_Circuit1]; //...

var _Circuit = {
  MinX: 0,
  MaxX: 0,
  MinY: 0,
  MaxY: 0, // ZONA DE INICIO
  DriveDirection: 0,
  StartDirection: undefined,
  endMinX: 0,
  endMaxX: 0,
  endMinY: 0,
  endMaxY: 0, // ZONA DE META
  endDriveDirection: 0,
  endStartDirection: undefined,
  Name: undefined,
  BestTime: [999.99, undefined],
  MainColor: [0x000000, 0x000000, 0x000000],
  AvatarColor: 0x000000,
  Angle: 0,
  Team: 0,
  ID: 0,
};

var colors = {
  commands: 0xffffff,
  info: 0xffffff,
  lapChanged: 0xffffff,
  lapTime: 0x2df73b,
  mapChangeWrongName: 0xffff00,
  mapChangeDeny: 0xff0000,
  mapLoad: 0x80ff00,
  mapLoadDeny: 0xffff00,
  speed: 0x2df73b,
  trackRecord: 0xff33d0,
};
var fonts = {
  commands: "normal",
  info: "normal",
  lapChanged: "normal",
  lapTime: "normal",
  mapChangeWrongName: "normal",
  mapChangeDeny: "bold",
  mapLoad: "normal",
  mapLoadDeny: "normal",
  speed: "small",
  trackRecord: "bold",
};
var sounds = {
  commands: 1,
  info: 0,
  lapChanged: 1,
  lapTime: 1,
  mapChangeWrongName: 1,
  mapChangeDeny: 2,
  mapLoad: 1,
  mapLoadDeny: 1,
  speed: 0,
  trackRecord: 1,
};

var playerList = {};
var commands = {
  admin: "!admin",
  commands: "!commands",
  mapInfo: "!map",
  mapLoad: "!circuit",
  maps: "!maps",
  speed: "!speed",
};

var adminChanges = [
  "'s admin rights were taken away",
  " was given admin rights",
];
var playerKicked = [" was kicked", " was banned"];
var speedEnableChanges = ["OFF", "ON"];
var teams = ["spectators", "red", "blue"];

var isRoomSet = false;

var room = HBInit({
  roomName: "F1 RACING BOT TEST ROOM",
  noPlayer: true,
  public: true,
  maxPlayers: 12,
  password: "1234567890",
});

room.setScoreLimit(0);
room.setTimeLimit(0);
room.setTeamsLock(true);
room.setCustomStadium(Circuit1);

function checkIfTrolling() {
  var players = room
    .getPlayerList()
    .filter(
      (p) =>
        room.getPlayerDiscProperties(p.id) != null &&
        ifInLapChangeZone(p) == true
    );

  players.forEach((p) => {
    if (_Circuit.StartDirection == "X") {
      if (
        Math.sign(room.getPlayerDiscProperties(p.id).xspeed) ==
        -1 * _Circuit.DriveDirection
      ) {
        room.kickPlayer(p.id, "Trolling detected!", false);
      }
    } else if (_Circuit.StartDirection == "Y") {
      if (
        Math.sign(room.getPlayerDiscProperties(p.id).yspeed) ==
        -1 * _Circuit.DriveDirection
      ) {
        room.kickPlayer(p.id, "Trolling detected!", false);
      }
    }
  });
}

function checkPlayerProgress() {
  var players = room
    .getPlayerList()
    .filter((p) => room.getPlayerDiscProperties(p.id) != null);

  players.forEach((p) => {
    const playerPos = room.getPlayerDiscProperties(p.id);
    const playerDisc = room.getPlayerDiscProperties(p.id);
    const playerName = p.name;
    const now = room.getScores().time;

    const isCurrentlyInStartZone =
      _Circuit.MinX <= playerPos.x &&
      playerPos.x <= _Circuit.MaxX &&
      _Circuit.MinY <= playerPos.y &&
      playerPos.y <= _Circuit.MaxY;
    const isCurrentlyInEndZone =
      _Circuit.endMinX <= playerPos.x &&
      playerPos.x <= _Circuit.endMaxX &&
      _Circuit.endMinY <= playerPos.y &&
      playerPos.y <= _Circuit.endMaxY;

    // Resetear la bandera 'inStartZone' cuando el jugador sale de la zona
    if (playerList[playerName].inStartZone && !isCurrentlyInStartZone) {
      playerList[playerName].inStartZone = false;
    }

    // Resetear la bandera 'inEndZone' cuando el jugador sale de la zona
    if (playerList[playerName].inEndZone && !isCurrentlyInEndZone) {
      playerList[playerName].inEndZone = false;
    }

    // Lógica de inicio de etapa: Se activa SOLO al ENTRAR a la zona de inicio
    if (
      !playerList[playerName].hasStarted &&
      isCurrentlyInStartZone &&
      !playerList[playerName].inStartZone
    ) {
      const correctDirection =
        (_Circuit.StartDirection === "X" &&
          Math.sign(playerDisc.xspeed) === _Circuit.DriveDirection) ||
        (_Circuit.StartDirection === "Y" &&
          Math.sign(playerDisc.yspeed) === _Circuit.DriveDirection);

      if (correctDirection) {
        playerList[playerName].hasStarted = true;
        playerList[playerName].startTime = now;
        playerList[playerName].inStartZone = true; // El jugador está ahora en la zona de inicio
        console.log(
          `${playerName} ha cruzado la línea de salida. Cronómetro en marcha.`
        );
      }
    }

    // Lógica de fin de etapa: Se activa SOLO al ENTRAR a la zona de meta
    if (
      playerList[playerName].hasStarted &&
      isCurrentlyInEndZone &&
      !playerList[playerName].inEndZone
    ) {
      const correctDirection =
        (_Circuit.endStartDirection === "X" &&
          Math.sign(playerDisc.xspeed) === _Circuit.endDriveDirection) ||
        (_Circuit.endStartDirection === "Y" &&
          Math.sign(playerDisc.yspeed) === _Circuit.endDriveDirection);

      if (correctDirection) {
        const stageTime = now - playerList[playerName].startTime;
        playerList[playerName].stageTime = stageTime;

        playerList[playerName].hasStarted = false; // La etapa ha terminado
        playerList[playerName].inEndZone = true; // El jugador está ahora en la zona de meta

        room.sendAnnouncement(
          `🏁 ¡${playerName} ha terminado la etapa! Tiempo: ${serialize(
            stageTime
          )} segundos`,
          p.id,
          colors.lapTime,
          fonts.lapTime,
          sounds.lapTime
        );
        console.log(
          `${playerName} ha cruzado la línea de meta. Tiempo: ${serialize(
            stageTime
          )} segundos.`
        );
      }
    }
  });
}

function endRaceSession() {
  var players = room
    .getPlayerList()
    .filter((p) => room.getPlayerDiscProperties(p.id) != null);
  var id = _Circuits.findIndex((c) => c.Name == _Circuit.Name);
  var next = Circuits[id + 1];

  if (room.getScores() != null) {
    if (players.length == 0) {
      room.stopGame();
      setTimeout(function () {
        if (id < Circuits.length) {
          room.setCustomStadium(next);
          room.startGame();
        } else {
          room.setCustomStadium(Circuits[0]);
          room.startGame();
        }
      }, gameEndTimeout);
    }
  }
}

function ifInLapChangeZone(player) {
  return (
    room.getScores().time > 0 &&
    _Circuit &&
    _Circuit.MinX <= room.getPlayerDiscProperties(player.id).x &&
    room.getPlayerDiscProperties(player.id).x <= _Circuit.MaxX &&
    _Circuit.MinY <= room.getPlayerDiscProperties(player.id).y &&
    room.getPlayerDiscProperties(player.id).y <= _Circuit.MaxY
  );
}

function logPlayerSpeed() {
  var players = room
    .getPlayerList()
    .filter(
      (p) =>
        room.getPlayerDiscProperties(p.id) != null &&
        playerList[p.name].speedEnabled == true
    );

  players.forEach((p) => {
    room.setPlayerAvatar(
      p.id,
      Math.floor(
        10 *
          Math.hypot(
            room.getPlayerDiscProperties(p.id).xspeed,
            room.getPlayerDiscProperties(p.id).yspeed
          )
      ).toString()
    );
  });
}

function serialize(number) {
  return number.toFixed(3);
}

room.onGamePaused = function (byPlayer) {
  byPlayer == null
    ? console.log(`Game paused`)
    : console.log(`Game paused by ${byPlayer.name}`);
};

room.onGameStart = function (byPlayer) {
  byPlayer == null
    ? console.log(`Game started`)
    : console.log(`Game started by ${byPlayer.name}`);

  var players = room.getPlayerList();
  players.forEach((p) => {
    // Reiniciamos las variables de rally
    playerList[p.name].hasStarted = false;
    playerList[p.name].startTime = 0;
    playerList[p.name].stageTime = 0;
  });
};

room.onGameStop = function (byPlayer) {
  byPlayer == null
    ? console.log(`Game stopped`)
    : console.log(`Game stopped by ${byPlayer.name}`);

  var players = room.getPlayerList();
  players.forEach((p) => {
    // Reiniciamos las variables de rally
    playerList[p.name].hasStarted = false;
    playerList[p.name].startTime = 0;
    playerList[p.name].stageTime = 0;
  });
};

room.onGameTick = function () {
  checkIfTrolling();
  checkPlayerProgress();
  endRaceSession();
  logPlayerSpeed();
};

room.onGameUnpaused = function (byPlayer) {
  byPlayer == null
    ? console.log(`Game unpaused`)
    : console.log(`Game unpaused by ${byPlayer.name}`);
};

room.onKickRateLimitSet = function (min, rate, burst, byPlayer) {
  byPlayer == null
    ? console.log(
        `Kick rate limit set as min: ${min} max: ${max} burst: ${burst}`
      )
    : console.log(
        `Kick rate limit set as min: ${min} max: ${max} burst: ${burst} by ${byPlayer.name}`
      );
};

room.onPlayerAdminChange = function (changedPlayer, byPlayer) {
  byPlayer == null
    ? console.log(
        `${changedPlayer.name}${adminChanges[Number(changedPlayer.admin)]}`
      )
    : console.log(
        `${changedPlayer.name}${adminChanges[Number(changedPlayer.admin)]} by ${
          byPlayer.name
        }`
      );
};

room.onPlayerChat = function (player, message) {
  console.log(`${player.name}: ${message}`);

  if (player.admin == true) {
    if (message.toLowerCase().split(" ")[0] == commands.admin) {
      room.setPlayerAdmin(player.id, !player.admin);
      return false;
    } else if (message.toLowerCase().split(" ")[0] == commands.commands) {
      room.sendAnnouncement(
        "Available commands: !admin, !circuit [ID], !commands, !map, !maps, !speed",
        player.id,
        colors.commands,
        fonts.commands,
        sounds.commands
      );
      return false;
    } else if (message.toLowerCase().split(" ")[0] == commands.mapInfo) {
      room.sendAnnouncement(
        `${_Circuit.Name} best lap: ${serialize(
          _Circuit.BestTime[0]
        )} seconds by ${_Circuit.BestTime[1]}`,
        player.id,
        colors.mapInfo,
        fonts.mapInfo,
        sounds.mapInfo
      );
      return false;
    } else if (message.toLowerCase().split(" ")[0] == commands.mapLoad) {
      var id = message.toLowerCase().split(" ")[1];

      if (id < 1 || id > _Circuits.length) {
        room.sendAnnouncement(
          `Invalid ID`,
          player.id,
          colors.mapLoadDeny,
          fonts.mapLoadDeny,
          sounds.mapLoadDeny
        );
      } else {
        room.setCustomStadium(Circuits[id - 1]);
        room.sendAnnouncement(
          `${_Circuits[id - 1].Name} was loaded by ${player.name}`,
          null,
          colors.mapLoad,
          fonts.mapLoad,
          sounds.mapLoad
        );
      }

      return false;
    } else if (message.toLowerCase().split(" ")[0] == commands.maps) {
      room.sendAnnouncement(
        `Map list below:\n${_Circuits
          .map((c) => c.Name + " [" + c.ID + "]")
          .join("\n")}`,
        player.id,
        colors.info,
        fonts.info,
        sounds.info
      );
      return false;
    } else if (message.toLowerCase().split(" ")[0] == commands.speed) {
      playerList[player.name].speedEnabled =
        !playerList[player.name].speedEnabled;
      room.sendAnnouncement(
        `Speed is turned ${
          speedEnableChanges[Number(playerList[player.name].speedEnabled)]
        }`,
        player.id,
        colors.speed,
        fonts.speed,
        sounds.speed
      );

      if (playerList[player.name].speedEnabled == true)
        room.setPlayerAvatar(player.id);

      return false;
    }
  } else {
    if (message.toLowerCase().split(" ")[0] == commands.admin) {
      room.setPlayerAdmin(player.id, !player.admin);
      return false;
    } else if (message.toLowerCase().split(" ")[0] == commands.commands) {
      room.sendAnnouncement(
        "Available commands: !admin, !commands, !map, !speed",
        player.id,
        colors.commands,
        fonts.commands,
        sounds.commands
      );
      return false;
    } else if (message.toLowerCase().split(" ")[0] == commands.mapInfo) {
      room.sendAnnouncement(
        `${_Circuit.Name} best lap: ${serialize(
          _Circuit.BestTime[0]
        )} seconds by ${_Circuit.BestTime[1]}`,
        player.id,
        colors.mapInfo,
        fonts.mapInfo,
        sounds.mapInfo
      );
      return false;
    } else if (message.toLowerCase().split(" ")[0] == commands.speed) {
      playerList[player.name].speedEnabled =
        !playerList[player.name].speedEnabled;
      room.sendAnnouncement(
        `Speed is turned ${
          speedEnableChanges[Number(playerList[player.name].speedEnabled)]
        }`,
        player.id,
        colors.speed,
        fonts.speed,
        sounds.speed
      );

      if (playerList[player.name].speedEnabled == true)
        room.setPlayerAvatar(player.id);

      return false;
    }
  }
};

room.onPlayerKicked = function (kickedPlayer, reason, ban, byPlayer) {
  byPlayer == null
    ? console.log(
        `${kickedPlayer.name} ${playerKicked[Number(ban)]} (${reason})`
      )
    : console.log(
        `${kickedPlayer.name} ${playerKicked[Number(ban)]} by ${
          byPlayer.name
        } (${reason})`
      );
};

room.onPlayerJoin = function (player) {
  console.log(`${player.name} has joined`);
  var players = room.getPlayerList();

  var lapTimes = [];
  for (var i = 0; i < limit; i++) {
    lapTimes.push(0);
  }

  if (playerList[player.name] == undefined)
    playerList[player.name] = {
      name: player.name,
      id: player.id,
      currentLap: 0,
      lapChanged: false,
      lapTimes: lapTimes,
      speedEnabled: false,
      isInTheRoom: true,
      hasStarted: false,
      startTime: 0,
      stageTime: 0,
      inStartZone: false,
      inEndZone: false,
    };
  if (room.getScores() == null && players.length == 1) {
    if (_Circuit.Team != 0) room.setPlayerTeam(player.id, _Circuit.Team);

    room.startGame();
  }
};

room.onPlayerLeave = function (player) {
  console.log(`${player.name} has left`);
  var players = room.getPlayerList();

  playerList[player.name].currentLap = 0;
  playerList[player.name].lapChanged = false;
  playerList[player.name].isInTheRoom = false;

  if (room.getScores() != null && players.length == 0) {
    room.stopGame();
  }
};

room.onPlayerTeamChange = function (changedPlayer, byPlayer) {
  byPlayer == null
    ? console.log(
        `${changedPlayer.name} was moved to ${teams[changedPlayer.team]}`
      )
    : console.log(
        `${changedPlayer.name} was moved to ${teams[changedPlayer.team]} by ${
          byPlayer.name
        }`
      );

  playerList[changedPlayer.name].currentLap = 0;
  playerList[changedPlayer.name].lapChanged = false;
};

room.onPositionsReset = function () {
  var players = room.getPlayerList();
  players.forEach((p) => {
    playerList[p.name].currentLap = 0;
    playerList[p.name].lapChanged = false;
    for (var l = 0; l < playerList[p.name].lapTimes.length; l++) {
      playerList[p.name].lapTimes[l] = 0;
    }
  });
};

room.onRoomLink = function (url) {
  if (isRoomSet == false) {
    console.log(`Room set with url: ${url}`);
    isRoomSet = true;
  }
};

room.onStadiumChange = function (newStadiumName, byPlayer) {
  byPlayer == null
    ? console.log(`${newStadiumName} was loaded`)
    : console.log(`${newStadiumName} was loaded by ${byPlayer.name}`);

  var c = _Circuits.find((x) => x.Name == newStadiumName);
  var players = room.getPlayerList();
  var admins = room.getPlayerList().filter((p) => p.admin == true);

  players.forEach((p) => room.setPlayerTeam(p.id, c.Team));

  if (byPlayer == null) {
    if (c) {
      _Circuit = {
        MinX: c.MinX,
        MaxX: c.MaxX,
        MinY: c.MinY,
        MaxY: c.MaxY,
        DriveDirection: c.DriveDirection,
        StartDirection: c.StartDirection,

        // ¡Añade estas líneas!
        endMinX: c.endMinX,
        endMaxX: c.endMaxX,
        endMinY: c.endMinY,
        endMaxY: c.endMaxY,
        endDriveDirection: c.endDriveDirection,
        endStartDirection: c.endStartDirection,

        Name: c.Name,
        BestTime: [c.BestTime[0], c.BestTime[1]],
        MainColor: c.MainColor,
        AvatarColor: c.AvatarColor,
        Angle: c.Angle,
        Team: c.Team,
        ID: c.ID,
      };
      room.setTeamColors(c.Team, c.Angle, c.AvatarColor, c.MainColor);
    } else {
      admins.length > 0
        ? admins.forEach((p) =>
            room.sendAnnouncement(
              `Something went wrong with map ${newStadiumName}. Please try again!`,
              p.id,
              colors.mapChangeWrongName,
              fonts.mapChangeWrongName,
              sounds.mapChangeWrongName
            )
          )
        : room.sendAnnouncement(
            `Something went wrong with map ${newStadiumName}. Please call an admin to try again!`,
            null,
            colors.mapChangeWrongName,
            fonts.mapChangeWrongName,
            sounds.mapChangeWrongName
          );
    }
  } else {
    room.sendAnnouncement(
      "You don't have authorization to change maps in this room!",
      byPlayer.id,
      colors.mapChangeDeny,
      fonts.mapChangeDeny,
      sounds.mapChangeDeny
    );
    room.setCustomStadium(Circuits[0]);
  }
};
